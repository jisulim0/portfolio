<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>
    <title>환경 모니터링</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <!-- 만든 css파일 연결 -->
    <link rel="stylesheet" href="css/navDesign.css">

    <script src="/__/firebase/7.19.0/firebase-app.js"></script>
    <script src="/__/firebase/7.19.0/firebase-analytics.js"></script>
    <script src="/__/firebase/7.19.0/firebase-auth.js"></script>
    <script src="/__/firebase/7.19.0/firebase-database.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>

    
  </head>
  <body>
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                        <span class="sr-only"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">Result of Monitoring</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li class = "active"><a href="#">환경 모니터링<span class="sr-only"></span></a></li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <div class="container">
            <select name="classroom" id='classroom' onchange = "classOnChangeListener()">
                <option value="test" selected="selected">Farm1</option>
            </select>

            <select name="classroom" id='envinfo' onchange = "classOnChangeListener()">
              <option value="Temperature" selected="selected">온도</option>
              <option value="Humidity">습도</option>
              <option value="Wind Direction">풍향</option>
              <option value="Wind Velocity">풍속</option>
          </select>
        </div>
        
        <div class="container">
            <div class="row">
                <div class="col-xl-8 col-lg-7">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
        
        <script>
            //json을 Array로 반환
            function jsonKeyToArray(json){
                return Object.keys(json);
            }
            
            function jsonKeyToArray(json){
                return Object.values(json);
            }
        </script>
        
        <script>
            //파이어베이스와 통신하여 className의 데이터를 읽어옵니다. 
            function dataLoad(className, envName) {
                database = firebase.database().ref("/"+className);
                data = database.once('value').then(function(snapshot) {
                    var dataset = snapshot.val();
                    console.log(dataset);
                    console.log(envName);
                    dataArray = getChartData(dataset, envName);
                    chartUpdate(dataArray);
                });
            }
            
            function getChartData(data, envName){
                //차트에 넣어줄 데이터 생성
                
                var labels = [];
                var datas = [];
                
                jsonLength = Object.keys(data).length; //json의 길이
                latestDate = Object.keys(data)[jsonLength - 1]; //최신날짜
                latestData = Object.values(data)[jsonLength - 1]; //최신날짜의 데이터
    
                
                dataLength = Object.keys(latestData).length;

                console.log(data);

                if(dataLength < 10){
                //console.log('데이터부족'); // 차트에 표시할 데이터가 10개 미만
                    
                    oldDate = Object.keys(data)[jsonLength - 2]; //이전날짜
                    oldData = Object.values(data)[jsonLength - 2]; //이전데이터
                    
                    oldDataLength = Object.keys(oldData).length;
                    
                    for(var i = oldDataLength -10 + dataLength; i < oldDataLength; ++i){
                        labels.push(oldDate + " " + Object.keys(oldData)[i]);
                        datas.push(Object.values(oldData)[i][envName])
                    }
                    
                    for(var i = dataLength - dataLength; i < dataLength; ++i){
                        labels.push(latestDate + " " + Object.keys(latestData)[i]);
                        datas.push(Object.values(latestData)[i][envName])
                    }
                    
                    return [labels, datas];
                    
                    
                }else{
    //                console.log('충분');
                    for(var i = dataLength - 10; i < dataLength; ++i){
                        labels.push(latestDate + " " + Object.keys(latestData)[i]);
                        datas.push(Object.values(latestData)[i][envName]);
                    }
                    
                    return [labels, datas];
                    
                }
                
    //            console.log(latestData);
    //            return latestData;
            }
            
            
            //selectBox의 변화이벤트를 감지하여 차트를 새롭게 그립니다..
            function classOnChangeListener() {
                selectBox = document.getElementById('classroom');
                envBox = document.getElementById('envinfo');

                className = selectBox.options[selectBox.selectedIndex].value;
                envName = envBox.options[envBox.selectedIndex].value;
                
                data = dataLoad(className, envName);
            }
            
            
            
        </script>
        
        <script>
            //화면 로딩때 데이터를 한번 받기 위하여 호출
            classOnChangeListener()
        </script>
        
        
        <!-- Chart -->
        <script>
            var chartLabels = new Array;
            var chartDatas = new Array;
    
            function chartUpdate(data) {
    
                chartLabels.length = 0;
                chartDatas.length = 0;
                
                for(i = 0; i < 10; ++i){
                    chartLabels.push(data[0][i]);
                    chartDatas.push(data[1][i]);
                }
                console.log(chartDatas);
    
                myChart.update();
                
            }
    
            var ctx = document.getElementById('myChart');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '날짜별 데이터',
                        data: chartDatas,
                        backgroundColor: [
                            'rgba(0, 0, 0, 0)'
                        ],
                        borderColor: [
                            'rgba(150, 150, 255, 1)'
                        ],
                        pointBackgroundColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: true,
                    scales: {
                        yAxes: [{
                            ticks: { //true일시 0부터 시작하는 고정값이 나옴
                                beginAtZero: false
                            }
                        }]
                    },
                }
            });
            
            console.log("test " + chartDatas);
        </script>
       
       
            
        <!-- Chart End -->
    
        <footer style="background-color: #000000; color: white">
            <div class="container">
                <br>
                <div class="row">
                    <div class="col-sm-2" style="text-align: center; color: gray;">
                        <h5>Copyright &copy; 2020</h5>
                        <h5>web demo_ver1.0</h5>
                    </div>
                    <div class="col-sm-5" style="color: gray;">
                        <h3></h3>
                        <h4>Monitoring the environment for Smartfarms</h4>
                        <p>including soil moisture sensing</p>
                    </div>
                </div>
            </div>
        </footer>
    
        <!--자바스크립트 사용-->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="js/bootstrap.js"></script>
    
  

  </body>
</html>
